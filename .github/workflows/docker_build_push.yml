name: Docker Build and Push
# Builds a new docker image and push it to dockerhub
on:
  workflow_call:
    inputs:
      tags:
        description: Docker tags to publish with (comma seperated)
        required: true
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
jobs:
  build:
    name: Docker Build and Push
    runs-on: ubuntu-latest
    steps:
      - name: Generate Docker Tags
        id: generate_tags
        uses: actions/github-script@v7
        env:
          DOCKER_HUB_REPO: custom-metrics
          TAGS: ${{ inputs.tags }}
        with:
          script: |
            const { DOCKER_HUB_REPO, TAGS } = process.env;
            const tags = TAGS.replaceAll("+", "_").split(",");
            const fullNames = tags.map(tag => `digiserve/${DOCKER_HUB_REPO}:${tag}`);
            core.setOutput('full_tags', fullNames.join(","));

      - name: Checkout to update the context for building and pushing the Docker package
        uses: actions/checkout@v5
        with:
          ref: master
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/arm/v8,linux/amd64,linux/arm64
          build-args: |
            BUILDPLATFORM=linux/arm/v8
            TARGETPLATFORM=linux/arm/v8
          tags: ${{ steps.generate_tags.outputs.full_tags }}
